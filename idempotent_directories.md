---
RFC: unassigned
Author: Alan Smithee <asmithee@example.com>
Status: Draft
Type: <Standards Track, Informational, Process>
---

# Title

Update the directory resource to allow for managed directories

## Motivation

    As a SysAdmin,
    I want to be able to manage directories idempotantly,
    so that I know the exact state of a directory over time and no drift occurs.

## Specification

When a directory resource is specified, it should allow for an optional attribute 'purge' to be specified. This would dictate that the only files/directories present within this directory tree are those that have been placed there as part of the chef run.

```ruby
directory "/var/lib/foo" do
  mode '0755'
  action :create
  purge true
end

```

The directory is created with the above command, and then various template/file resources, LWRPs, etc then execute to populate the directory. At the end of the chef run, the directory is then checked for any files/directories that have not been explcitily defined as part of the chef run and purges them.

The implementation would be similar to the zap_directory functionality defined in https://github.com/nvwls/zap.git but with the ability to recurse down through subdirectories.



## Rationale

At present it is very difficult to manage directory structures in an idempotent fashion, ensuring that the servers do not drift. It is very difficult to assert that only the files required are in a directory tree and no others.

At present there are only two mechanisms in current chef.

* Using *remote_directory*' with the purge parameter

  ```ruby
  remote_directory "/var/lib/foo" do
      mode '0755'
      action :create
      purge true
  end
  ```
  This doesn't give the necessary control over the directory tree. Since only flat, non-templated files can be specified in this way it limits the usefulness.
  
 It does not allow for templated content or content generated by LWRPs

* Using directory/delete before directory/create

  This asserts that the files are in the right place but is far from idempotent. At worst, it deletes the files and reinserts them. It would also generate notification events each and every run. 
  
* Integrating the *zap* cookbook

  This is problematic when trying to use with community cookbooks because it requires retrofitting into existing cookbooks not designed to work with zap. If the functionality was present in the core product this functionality would be more widely adopted.
  
  
There needs to be a solution that works idempotently without firing any unnecessary requests and generates no unnecessary events. So that when lastrun is installed and you run two consecutive chef runs with no changes then following...

```bash
knife node lastrun mynode
```

... should report no actions associated with the directory.

For context, both puppet and salt have solutions to this problem...

In puppet, this would be...

```text
file { "/var/lib/foo":
  ensure  => directory, 
  recurse => true, 
  purge   => true, # purge all unmanaged junk
  force   => true, # also purge subdirs and links etc.
  mode    => 0755
}
```



## Copyright

This work is in the public domain. In jurisdictions that do not allow for this,
this work is available under CC0. To the extent possible under law, the person
who associated CC0 with this work has waived all copyright and related or
neighboring rights to this work.

